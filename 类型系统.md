#类型系统(type system)

##为什么需要类型系统

###什么是类型(type)

在计算机程序语言中，类型(type)是指一个能够进行某些运算(operation)的值(value)的集合。值是指程序中表达式运算得到的任意的合法取值。

由此可见，类型的定义，很像抽象代数中的群、环、域等数学结构的定义。比如群的定义便是：包含一个满足某些性质（比如封闭性）的运算的非空集合。更通俗地说，整数类似一个群，它包含了所有合法的整数的集合以及加减乘除等作用在集合元素之上的运算，这些运算还满足一些性质，比如加法结合律、交换律等。

抽象代数做为计算机的理论基础之一，在计算机程序中找到与其有某种程度同构的结构，似乎理所当然。然而，而正是这种同构，揭示了计算机程序中为什么会存在类型以及类型系统这些概念。下文我们马上会揭示这一点。

###什么是类型系统

在计算机程序语言中，类型系统包含了一个规则的集合，这些规则将类型属性附加于组成程序的各种结构之上，比如变量、表达式、函数、模块等。

也就是说，类型系统是关于类型的规则。这些规则规定了程序中的结构如何取得类型、变换类型；类型间如何进行运算等。

###类型系统的作用

那么，为什么需要类型系统？这得从计算机程序如何解决实际问题说起。总的来说，在计算机程序中引入类型系统的主要作用包括：

- 类型使得计算机程序在底层的基础结构上和问题域的数学模型构成同构关系，从而使计算机程序具备了方便地映射数学模型的能力，最终使计算机程序能够便捷、以一种同构的方式实现数学模型，从而解决问题域中的问题。
- 类型系统定义的类型，当这些类型的变量、表达式在程序的不同部分通过接口进行传递时，能够提供数据一致性，从而减少错误的产生，同时，也为模块的实现减少对输入数据进行某种检验的额外负担和复杂度。

以上第2点比较好理解，这里只解释第1点。

我们知道，编写计算机程序是为了解决现实世界的问题。而解决问题的一般步骤是：

	现实世界 - 问题域 - 数学模型 - 计算机程序 - 计算机 - 现实世界

即，从现实世界中得到某个问题，对这个问题建立数学模型，并提供解决方法。用计算机程序实现这个解决方法，计算机程序通过计算机运行后，计算机作用于现实世界，从而解决最开始面临的问题。

而计算机程序要实现数学模型，是需要人们把数学模型映射到程序中的。这时，有一个清晰的映射就非常重要。而同构，无疑是最清晰的映射结构。同时，由于数学模型中存在一些基本的结构，比如集合和运算。那么，为了同构，程序中也必须设计类似的结构，于是，集合和在集合上的运算，在程序中就被定义为类型。

实际上，以上解决问题的步骤链中，这种同构不仅仅在数学模型和计算机程序之间存在，而几乎存在在每两个步骤之间。比如下表列出类一组不同步骤之间的明显同构结构——“实体和过程关系的同构”。

表1 实体和过程关系的同构

![实体和过程关系的同构](./epri.png)

##类型系统的分类

类型系统按照类型检查的时间，可分为：

- 静态类型
- 动态类型

按照对类型转换的限制程度，又可分为：

- 弱类型
- 强类型

静态类型和动态类型的定义较唯一，而弱类型和强类型的定义，则有多个。但这些类型，都是通过具体的语言特性（feature)体现出来的，和类型系统分类相关的语言特性包括：

- 编译时检查类型错误，运行时检查类型错误
- 变量需要声明其所属的类型
- 可以在不同类型之间进行隐式类型转换
- 变量的类型随其值的类型的改变而改变

为了说明以上4点和4种分类之间的关系，我们对比同一段简单的代码的PHP版本和C语言版本，来直观地看看属于不同分类之间的语言之间的差异。

PHP版本的代码：

```
function f($arg){
	return strlen($arg);
}

$i = 0;
$f = 0.0;
$rst = 1;
$rst = $i + $f;

f($rst);
```
C版本的代码：
```
int f(char * arg){
	return strlen(arg);
}

int i = 0;
float f = 0.0;
int rst = 1;
rst = i + f;

f(rst);
```


###动静之间

**静态类型**指编译时对类型进行检查的类型系统，而因为需要在静态时对变量、表达式、函数参数进行类型检查，因此，需要在使用变量以及调用函数之间，对这变量和函数参数的类型进行声明。即，静态类型包含以下2个语言特性：

- 编译时检查类型错误
- 变量需要声明其所属的类型

**动态类型**则相反，是在运行时对类型进行检查的类型系统。同样，由于其并可以在运行时根据变量的值来确定类型和检查类型，因此它并不需要在变量被使用前声明其类型。PHP正是动态类型的语言。动态类型语言包含以下特性：

- 运行时检查类型错误
- 变量不需要声明其所属的类型

来看看上面的代码。PHP版本中,变量`$i,$f,$rst`和函数形参`$arg`在使用前，并没有声明其类型。而相应的变量在C语言的版本中，则一定要声明其所属的类型。

在类型检查的时机方面，PHP的代码在运行时才会发现函数`f()`的参数并不是它所需要的string类型。而C版本的代码，在编译时就会报错，`f()`函数已经通过声明参数类型告诉编译器，它需要的是一个char*类型，而却被用int类型调用。

而编译器能发现调用类型和声明类型不符，正是因为`rst`和函数参数`arg`都声明了其类型，才能进行比较。相反由于PHP版中的`$rst`的类型在运行时才能根据其值确定，因此，只能在运行时检查。也就是说，编译时检查要求了对变量的类型进行声明，而不对变量的类型进行声明，就只能在运行时进行检查。是否声明类型和在何时检查，是相生相克的关系。

那么，这两种分类各自的优缺点分别是什么？

静态类型语言的最大优点是相对安全，体现在以下几方面：

- 编译时就能发现类型相关的错误，而不会等到运行时才发现。
- 函数、运算符、控制语句能够声明或默认规定其输入的类型，从而减少因类型错误而导致输出错误或程序错误。
- 在模块之间（比如函数之间）的接口声明好特定的类型，使模块间的数据一致性得到保证。

另外一个主要的优点是便于在阅读程序时辨别出变量的类型。

动态类型的主要优点则是相对灵活，体现在使用一个变量时，程序员无需考虑其类型，程序将自动根据值来确定变量类型，这减少了程序员的思考负担。

两者的缺点则都是对方有点的反面。

总体而言，静态类型由于其较为安全，因此大体上可以说其优于动态类型。而PHP采用动态类型，很大程度上是因为它是一门解释执行的语言。在解释执行的语言中，编译和执行并不是分阶段执行的，而是一边编译一边执行，因此，采用动态类型检查比静态类型检查更为自然。

对于使用PHP的动态类型而言，我们要注意利用其优点而避免其缺点导致的错误。

###强弱之辨

强类型和弱类型并没有一个公认的统一定义。先来看看其中的一种定义。

弱类型语言指满足以下特性的语言：

- 可以在不同类型之间进行隐式类型转换
- 变量的类型随其值的类型的改变而改变

强类型则相反：

- 不可以在不同类型之间进行隐式类型转换
- 或者变量的类型是固定的，不随其值的类型的改变而改变

可见，类型的强弱，指的是程序中的变量在进行类型转换或变更时，类型对其约束的强弱。

安照这种定义，PHP是弱类型的语言，C则属于强类型。因为C语言中的类型之间虽然可以进行隐式转换，但变量的类型不随其值的变化而变化。

上文的PHP代码中，`$rst = $i + $f;`进行时，`$i`会被隐式地转为float类型再参与计算。而将得到float的结果赋值给`$rst`之后，`$rst`将由原来的int类型变为float类型。

C代码中，`rst = i + f;`中进行了类似的隐式类型转换，但`rst`的类型仍然是int,`i + f`的结果会被隐式转换为int后再赋值给`rst`。

强弱的另外一种定义是，只要可以在不同类型之间进行隐式类型转换，这种语言就是弱类型的，反之则是强类型的。如果从这个定义看，PHP和C则都是弱类型的。下文中，我们姑且使用第一定义。

强类型和弱类型的优缺点，同样在是灵活性和安全性之间的偏向不同。强类型不允许类型之间的隐式转换，带来更好的安全性，避免了因为预期以外的隐式类型转换造成的错误，但却会因为一些合理的转换也被杜绝了而造成一些灵活性的损失。而弱类型允许变量根据其值的类型确定其类型，则减少了程序员思考的负担，但也带来了更多因不确定性而造成的错误。

做为弱类型的语言，使用PHP时要注意：

- 只使用合理的隐式类型转换，比如int到float、打印时的int到string，不使用奇怪的转换。
- 尽量使变量的类型保持单一。除非变量对应的问题域实体，本身就表现出多种类型。

最后，注意到，无论是强类型还是弱类型、静态类型还是动态类型的语言，都是有类型的。虽然动态类型没有显式声明变量的类型，但不代表其没有类型。虽然弱类型可以在不同类型之间进行隐式转换，但能够进行类型转换也正意味着其必须先有类型。PHP也定义了一些类型，下几小节将一一介绍。
